# AFC_ACE Configuration Template
#
# This template is for the AFC_ACE system which features:
# - 2 stepper motors (selector + shared drive motor)
# - 3 positions per lane: LOAD, FREE, UNLOAD
# - 4 independent status LEDs (not Neopixel)
# - Dual sensors per lane (presence + tension)
# - 5 Hall effect tension sensors (4 per lane + 1 common)

[include mcu/AcePro.cfg]

# MCU Configuration
[mcu ACE]
serial: /dev/serial/by-id/usb-Klipper_stm32f103xe_57FFFFFF7283525518421067-if00
restart_method: command

[temperature_sensor ACE]
sensor_type: temperature_mcu
sensor_mcu: ACE

# AFC_ACE Unit Configuration
[AFC_ACE ACE_1]
type: ACE
hub: ACE_HUB_1
extruder: extruder
buffer: TurtleNeck                      # Optional: buffer/turtleneck name

# Stepper configuration
drive_stepper: ACE_Drive                # Shared drive motor for all lanes
selector_stepper: ACE_Selector          # Selector motor

# Selector settings
home_pin: ACE:HOME_POS                  # Home sensor pin
steps_per_lane: 100                     # Steps between lanes (calibrate for your setup)
steps_per_position: 50                  # Steps between positions (FREE/LOAD/UNLOAD)
selector_speed: 50                      # Selector movement speed in mm/s
selector_accel: 50                      # Selector acceleration in mm/s^2

# Tension sensor common pin (Hall sensor, closed when max tension)
tension_common_pin: ^!ACE:TENSION_COMMON

# Movement speeds
long_moves_speed: 150
long_moves_accel: 50
short_moves_speed: 25
short_moves_accel: 400

# Enable sensors in GUI
enable_sensors_in_gui: True

# Stepper Motor Configurations

# Shared drive motor (single motor with 4 gears)
[AFC_stepper ACE_Drive]
unit: ACE_1
step_pin: ACE:DRIVE_STEP
dir_pin: !ACE:DRIVE_DIR
enable_pin: !ACE:DRIVE_EN
microsteps: 64
rotation_distance: 38.43483             # Calibrated value from your config
gear_ratio: 25:10                       # Your gear ratio
full_steps_per_rotation: 200

[tmc2209 AFC_stepper ACE_Drive]
uart_pin: ACE:DRIVE_UART
uart_address: 0
run_current: 0.4
sense_resistor: 0.110
stealthchop_threshold: 0

# Selector motor
[AFC_stepper ACE_Selector]
unit: ACE_1
step_pin: ACE:SEL_STEP
dir_pin: ACE:SEL_DIR
enable_pin: !ACE:SEL_EN
microsteps: 64
rotation_distance: 20                   # From your config
gear_ratio: 25:10                       # Your gear ratio
full_steps_per_rotation: 200

[tmc2209 AFC_stepper ACE_Selector]
uart_pin: ACE:SEL_UART
uart_address: 0
run_current: 0.4
hold_current: 0.3
sense_resistor: 0.110
stealthchop_threshold: 0

# Lane Configurations
# Each lane uses the shared drive motor, selector chooses which lane is active

[AFC_lane lane1]
unit: ACE_1:1
dist_hub: 100                           # Distance from selector to hub (calibrate)
# Presence sensor (before drive mechanism)
prep: ^!ACE:PREP1
# Tension sensor (Hall effect, after drive mechanism)
load: ^!ACE:TENSION1

[AFC_lane lane2]
unit: ACE_1:2
dist_hub: 100
prep: ^!ACE:PREP2
load: ^!ACE:TENSION2

[AFC_lane lane3]
unit: ACE_1:3
dist_hub: 100
prep: ^!ACE:PREP3
load: ^!ACE:TENSION3

[AFC_lane lane4]
unit: ACE_1:4
dist_hub: 100
prep: ^!ACE:PREP4
load: ^!ACE:TENSION4

# Hub Configuration
# Note: HUB sensor pin not defined yet - add to AcePro.cfg if you have a hub sensor
[AFC_hub ACE_HUB_1]
afc_bowden_length: 1750                 # Length of Bowden tube from hub to toolhead sensor (mm)
move_dis: 60                            # Distance to move filament within hub (mm)
hub_clear_move_dis: 55
# switch_pin: ^ACE:HUB                  # Uncomment and define HUB pin when available

# Optional: Filament cutter in hub
# cut: True
# cut_servo: cut_servo
# cut_angle: 45
# cut_clear: 170

# Individual LED Configuration (not Neopixel)
# These are white LEDs for filament presence indication per slot

[led LED_lane1]
white_pin: !ACE:LED1
initial_WHITE: 0.0

[led LED_lane2]
white_pin: !ACE:LED2
initial_WHITE: 0.0

[led LED_lane3]
white_pin: !ACE:LED3
initial_WHITE: 0.0

[led LED_lane4]
white_pin: !ACE:LED4
initial_WHITE: 0.0

# Notes on calibration:
# 1. Run HOME_UNIT UNIT=ACE_1 to home the selector
# 2. Use ACE_SET_POSITION UNIT=ACE_1 LANE=1 POSITION=1 to test selector movement
# 3. Calibrate steps_per_lane and steps_per_position by measuring actual movement
# 4. Calibrate dist_hub for each lane using CALIBRATE_AFC LANE=lane1
# 5. Calibrate afc_bowden_length using CALIBRATE_AFC BOWDEN=lane1
