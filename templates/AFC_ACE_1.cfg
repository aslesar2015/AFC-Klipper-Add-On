# AFC_ACE Configuration Template
#
# This template is for the AFC_ACE system which features:
# - 2 stepper motors (selector + shared drive motor)
# - 3 positions per lane: LOAD, FREE, UNLOAD
# - 4 independent status LEDs (not Neopixel)
# - Dual sensors per lane (presence + tension)
# - 5 Hall effect tension sensors (4 per lane + 1 common)

[include mcu/AcePro.cfg]

# MCU Configuration
[mcu ACE]
serial: /dev/serial/by-id/usb-Klipper_stm32f103xe_57FFFFFF7283525518421067-if00
restart_method: command

[temperature_sensor ACE]
sensor_type: temperature_mcu
sensor_mcu: ACE

# AFC_ACE Unit Configuration
[AFC_ACE ACE_1]
type: ACE
hub: ACE_HUB_1
extruder: extruder
# Optional: buffer configuration (if using TurtleNeck buffer, uncomment below)
# buffer: TurtleNeck

# Stepper configuration
drive_stepper: ACE_Drive                # Shared drive motor for all lanes
selector_stepper: ACE_Selector          # Selector motor

# Selector settings
home_pin: ACE:HOME_POS                  # Home sensor pin
lane1_offset: 1.5                       # Distance from HOME to Lane 1 LOAD position (mm) - measured value
steps_per_lane: 100                     # Distance between lanes (mm) - NEEDS CALIBRATION for lanes 2-4
steps_per_position: 5.0                 # Distance between positions within a lane (mm) - measured: LOAD to FREE = 5mm, FREE to UNLOAD = 5mm
selector_speed: 50                      # Selector movement speed in mm/s
selector_accel: 50                      # Selector acceleration in mm/s^2

# Tension sensor common pin (Hall sensor, closed when max tension)
tension_common_pin: ^!ACE:TENSION_COMMON

# Movement speeds
long_moves_speed: 150
long_moves_accel: 50
short_moves_speed: 25
short_moves_accel: 400

# Enable sensors in GUI
enable_sensors_in_gui: True

# Stepper Motor Configurations

# Shared drive motor (single motor with 4 gears)
[AFC_stepper ACE_Drive]
unit: ACE_1
step_pin: ACE:DRIVE_STEP
dir_pin: !ACE:DRIVE_DIR
enable_pin: !ACE:DRIVE_EN
microsteps: 64
rotation_distance: 38.43483             # Calibrated value from your config
gear_ratio: 25:10                       # Your gear ratio
full_steps_per_rotation: 200

[tmc2209 AFC_stepper ACE_Drive]
uart_pin: ACE:DRIVE_UART
uart_address: 0
run_current: 0.4
sense_resistor: 0.110
stealthchop_threshold: 0

# Selector motor
[AFC_stepper ACE_Selector]
unit: ACE_1
step_pin: ACE:SEL_STEP
dir_pin: ACE:SEL_DIR
enable_pin: !ACE:SEL_EN
microsteps: 64
rotation_distance: 20                   # From your config
gear_ratio: 25:10                       # Your gear ratio
full_steps_per_rotation: 200

[tmc2209 AFC_stepper ACE_Selector]
uart_pin: ACE:SEL_UART
uart_address: 0
run_current: 0.4
hold_current: 0.3
sense_resistor: 0.110
stealthchop_threshold: 0

# Tension Assist Configuration (Optional)
# AFC_ACE_tension provides active assist when printing
# - Active mode: Selector stays in LOAD, feeds filament when MINIMAL tension detected
# - Passive mode: Selector in FREE, filament moves freely
#
# ACE Tension Sensor System:
# - TENSION1-4 (individual): Trigger when filament has MINIMAL tension (slack) → feed needed
# - TENSION_COMMON (shared): Triggers at MAXIMUM tension → safety limit, stop feeding
#
# Uncomment the sections below if you want to use tension assist instead of TurtleNeck buffer

# [AFC_ACE_tension ACE_tension1]
# tension_pin: ^!ACE:TENSION1          # Tension sensor pin for lane 1
# assist_mode: passive                 # Mode: 'active' or 'passive'
# tension_feed_length: 10.0            # mm to feed when tension detected (active mode)
# tension_feed_speed: 50.0             # Feed speed in mm/s
# tension_feed_accel: 400.0            # Feed acceleration in mm/s^2
# hub_retract_distance: 20.0           # mm to retract from hub sensor into buffer zone
# debug: False                         # Enable debug logging
# enable_sensors_in_gui: True          # Show tension sensor in GUI

# [AFC_ACE_tension ACE_tension2]
# tension_pin: ^!ACE:TENSION2
# assist_mode: passive
# tension_feed_length: 10.0
# tension_feed_speed: 50.0
# tension_feed_accel: 400.0
# hub_retract_distance: 20.0

# [AFC_ACE_tension ACE_tension3]
# tension_pin: ^!ACE:TENSION3
# assist_mode: passive
# tension_feed_length: 10.0
# tension_feed_speed: 50.0
# tension_feed_accel: 400.0
# hub_retract_distance: 20.0

# [AFC_ACE_tension ACE_tension4]
# tension_pin: ^!ACE:TENSION4
# assist_mode: passive
# tension_feed_length: 10.0
# tension_feed_speed: 50.0
# tension_feed_accel: 400.0
# hub_retract_distance: 20.0

# Lane Configurations
# Each lane uses the shared drive motor, selector chooses which lane is active
#
# IMPORTANT: Sensor Pin Usage
# ----------------------------
# ACE has two types of sensors per lane:
# 1. PREP1-4: Presence sensors BEFORE drive mechanism
# 2. TENSION1-4: Hall effect sensors AFTER drive mechanism (detect tension, not just presence)
#
# If using AFC_ACE_tension (recommended):
#   - prep: PREP sensor (detects filament before drive)
#   - load: PREP sensor (same as prep, or use hub sensor if available)
#   - buffer: AFC_tension (uses TENSION sensor for active assist)
#   - Do NOT use TENSION pins as load sensors!
#
# If NOT using tension assist:
#   - prep: PREP sensor
#   - load: TENSION sensor (used as simple presence sensor)
#   - buffer: not defined

[AFC_lane lane1]
unit: ACE_1:1
dist_hub: 100                           # Distance from selector to hub (calibrate)

# Presence sensor before drive mechanism
prep: ^!ACE:PREP1

# Load sensor - choose ONE option:
# Option A: If using tension assist, use PREP sensor for load detection too
load: ^!ACE:PREP1                       # Same as prep (recommended with tension assist)
# Option B: If NOT using tension assist, use TENSION sensor as load sensor
# load: ^!ACE:TENSION1                  # Hall sensor used as presence detector

# Tension assist - uncomment to enable active tension monitoring
# buffer: ACE_tension1

[AFC_lane lane2]
unit: ACE_1:2
dist_hub: 100
prep: ^!ACE:PREP2
load: ^!ACE:PREP2                       # Using prep sensor (for tension assist compatibility)
# load: ^!ACE:TENSION2                  # Alternative: use as presence sensor (no tension assist)
# buffer: ACE_tension2

[AFC_lane lane3]
unit: ACE_1:3
dist_hub: 100
prep: ^!ACE:PREP3
load: ^!ACE:PREP3                       # Using prep sensor (for tension assist compatibility)
# load: ^!ACE:TENSION3                  # Alternative: use as presence sensor (no tension assist)
# buffer: ACE_tension3

[AFC_lane lane4]
unit: ACE_1:4
dist_hub: 100
prep: ^!ACE:PREP4
load: ^!ACE:PREP4                       # Using prep sensor (for tension assist compatibility)
# load: ^!ACE:TENSION4                  # Alternative: use as presence sensor (no tension assist)
# buffer: ACE_tension4

# Hub Configuration
# Note: HUB sensor pin not defined yet - add to AcePro.cfg if you have a hub sensor
[AFC_hub ACE_HUB_1]
afc_bowden_length: 1750                 # Length of Bowden tube from hub to toolhead sensor (mm)
move_dis: 60                            # Distance to move filament within hub (mm)
hub_clear_move_dis: 55
# switch_pin: ^ACE:HUB                  # Uncomment and define HUB pin when available

# Optional: Filament cutter in hub
# cut: True
# cut_servo: cut_servo
# cut_angle: 45
# cut_clear: 170

# Individual LED Configuration (not Neopixel)
# These are white LEDs for filament presence indication per slot

[led LED_lane1]
white_pin: !ACE:LED1
initial_WHITE: 0.0

[led LED_lane2]
white_pin: !ACE:LED2
initial_WHITE: 0.0

[led LED_lane3]
white_pin: !ACE:LED3
initial_WHITE: 0.0

[led LED_lane4]
white_pin: !ACE:LED4
initial_WHITE: 0.0

# Notes on calibration:
#
# Lane 1 positions (measured and configured):
#   HOME: 0mm (endstop position)
#   LOAD: 1.5mm (lane1_offset)
#   FREE: 6.5mm (lane1_offset + steps_per_position)
#   UNLOAD: 11.5mm (lane1_offset + steps_per_position * 2)
#
# Calibration steps:
# 1. Run HOME_UNIT UNIT=ACE_1 to home the selector
# 2. Test Lane 1 positions:
#    - ACE_SET_POSITION UNIT=ACE_1 LANE=1 POSITION=1  (should be at 1.5mm - LOAD)
#    - ACE_SET_POSITION UNIT=ACE_1 LANE=1 POSITION=0  (should be at 6.5mm - FREE)
#    - ACE_SET_POSITION UNIT=ACE_1 LANE=1 POSITION=2  (should be at 11.5mm - UNLOAD)
# 3. Calibrate steps_per_lane:
#    - Find Lane 2 LOAD position manually (web interface or manual command)
#    - Calculate: steps_per_lane = Lane2_LOAD_position - lane1_offset
#    - Repeat for lanes 3 and 4 to verify consistent spacing
# 4. After calibrating steps_per_lane, test all lanes:
#    - ACE_SET_POSITION UNIT=ACE_1 LANE=2 POSITION=1  (test Lane 2 LOAD)
#    - ACE_SET_POSITION UNIT=ACE_1 LANE=3 POSITION=1  (test Lane 3 LOAD)
#    - ACE_SET_POSITION UNIT=ACE_1 LANE=4 POSITION=1  (test Lane 4 LOAD)
# 5. Calibrate dist_hub for each lane using CALIBRATE_AFC LANE=lane1
# 6. Calibrate afc_bowden_length using CALIBRATE_AFC BOWDEN=lane1
